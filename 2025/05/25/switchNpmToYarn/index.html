<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="keywords" content="没事儿,tong-h,Tong-H,tong-h blog"><meta name="descriptioon" content="personal blog by Tong-H"><meta name="renderer" content="wekit"><link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/css/public.css"><link rel="stylesheet" href="/css/reset.css"><link rel="stylesheet" href="/css/iconfont.css"><title>升级老项目的包依赖 [ Tong-H ]</title><link rel="stylesheet" href="/css/partial/footer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><link rel="stylesheet" href="/css/partial/sidebar.css"><link rel="stylesheet" href="/css/post.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><meta name="generator" content="Hexo 5.4.0"></head><body><link rel="stylesheet" href="/css/partial/header.css"><div class="header"><div class="maxwidth"><div class="nav"><a id="artlist" href="/404"><i class="iconfont icon404"></i><span class="headhid">&nbsp;404</span></a><a id="artlist" href="/archives"><i class="iconfont iconarchives"></i><span class="headhid">&nbsp;Archives</span></a><a id="artlist" href="/about"><i class="iconfont iconabout"></i><span class="headhid">&nbsp;About</span></a></div><a class="search" href="/">TONG-H</a></div></div><div class="main"> <div class="maxwidth"><link rel="stylesheet" href="/css/partial/sidebar.css"><div id="sidebar"><div class="social"><a href="/archives" title="Home"><i class="iconfont iconHome"></i></a><a href="mailto:tongt0232@gmail.com" title="E-Mail"><i class="iconfont iconweibiaoti554"></i></a><a target="_blank" rel="noopener" href="https://github.com/tong-h" title="GitHub"><i class="iconfont iconGitHub"></i></a><a target="_blank" rel="noopener" href="https://juejin.cn/user/1204720474809741" title="juejin"><img src="/images/juejinicon-sidebar.png"></a><a target="_blank" rel="noopener" href="https://www.jianshu.com/u/20de04cc53de" title="jianshu"><img src="/images/jianicon-sidebar.png"></a></div><div class="structure category-list"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">背景介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Node-gyp-%E9%97%AE%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">Node-gyp 问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#node-gyp-%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98"><span class="toc-number">2.1.</span> <span class="toc-text">node-gyp 版本问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%BE%E4%B8%8D%E5%88%B0-python2-%E6%88%96-python3"><span class="toc-number">2.2.</span> <span class="toc-text">找不到 python2 或 python3</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#node-%E7%89%88%E6%9C%AC%E5%85%BC%E5%AE%B9"><span class="toc-number">3.</span> <span class="toc-text">node 版本兼容</span></a></li></ol></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Daily-Snippets/">Daily Snippets</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Frontend/">Frontend</a><span class="category-list-count">49</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Notes/">Notes</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Others/">Others</a><span class="category-list-count">14</span></li></ul><div class="tags"><a href="/tags/CI-CD/" style="font-size: 12px; color: #ffac00">CI/CD</a> <a href="/tags/Cache/" style="font-size: 15px; color: #ec9d00">Cache</a> <a href="/tags/ECharts/" style="font-size: 12px; color: #ffac00">ECharts</a> <a href="/tags/Electron/" style="font-size: 12px; color: #ffac00">Electron</a> <a href="/tags/Git/" style="font-size: 12px; color: #ffac00">Git</a> <a href="/tags/JS/" style="font-size: 12px; color: #ffac00">JS</a> <a href="/tags/JSON/" style="font-size: 12px; color: #ffac00">JSON</a> <a href="/tags/Linux/" style="font-size: 12px; color: #ffac00">Linux</a> <a href="/tags/OTHERS/" style="font-size: 12px; color: #ffac00">OTHERS</a> <a href="/tags/Svg/" style="font-size: 12px; color: #ffac00">Svg</a> <a href="/tags/angular/" style="font-size: 15px; color: #ec9d00">angular</a> <a href="/tags/canvas/" style="font-size: 21px; color: #c77e00">canvas</a> <a href="/tags/cordova/" style="font-size: 21px; color: #c77e00">cordova</a> <a href="/tags/domain/" style="font-size: 12px; color: #ffac00">domain</a> <a href="/tags/ffmpeg/" style="font-size: 12px; color: #ffac00">ffmpeg</a> <a href="/tags/financial/" style="font-size: 12px; color: #ffac00">financial</a> <a href="/tags/gitment/" style="font-size: 12px; color: #ffac00">gitment</a> <a href="/tags/hexo/" style="font-size: 18px; color: #da8d00">hexo</a> <a href="/tags/http/" style="font-size: 12px; color: #ffac00">http</a> <a href="/tags/japanese/" style="font-size: 15px; color: #ec9d00">japanese</a> <a href="/tags/js/" style="font-size: 15px; color: #ec9d00">js</a> <a href="/tags/mac/" style="font-size: 12px; color: #ffac00">mac</a> <a href="/tags/markdown/" style="font-size: 12px; color: #ffac00">markdown</a> <a href="/tags/micro-frontend/" style="font-size: 15px; color: #ec9d00">micro_frontend</a> <a href="/tags/mpvue/" style="font-size: 12px; color: #ffac00">mpvue</a> <a href="/tags/mysql/" style="font-size: 12px; color: #ffac00">mysql</a> <a href="/tags/nginx/" style="font-size: 12px; color: #ffac00">nginx</a> <a href="/tags/nodejs/" style="font-size: 12px; color: #ffac00">nodejs</a> <a href="/tags/npm/" style="font-size: 15px; color: #ec9d00">npm</a> <a href="/tags/python/" style="font-size: 18px; color: #da8d00">python</a> <a href="/tags/server/" style="font-size: 12px; color: #ffac00">server</a> <a href="/tags/shell/" style="font-size: 12px; color: #ffac00">shell</a> <a href="/tags/threeJs/" style="font-size: 12px; color: #ffac00">threeJs</a> <a href="/tags/translation/" style="font-size: 24px; color: #b46e00">translation</a> <a href="/tags/typescript/" style="font-size: 12px; color: #ffac00">typescript</a> <a href="/tags/vue/" style="font-size: 12px; color: #ffac00">vue</a> <a href="/tags/worker/" style="font-size: 12px; color: #ffac00">worker</a> <a href="/tags/yarn/" style="font-size: 12px; color: #ffac00">yarn</a> <a href="/tags/%E5%8E%9F%E5%9E%8B%E9%93%BE/" style="font-size: 12px; color: #ffac00">原型链</a> <a href="/tags/%E5%9B%BD%E9%99%85%E5%8C%96/" style="font-size: 12px; color: #ffac00">国际化</a> <a href="/tags/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%BB%9A%E5%8A%A8%E6%9D%A1/" style="font-size: 12px; color: #ffac00">自定义滚动条</a> <a href="/tags/%E8%B7%A8%E5%9F%9F/" style="font-size: 12px; color: #ffac00">跨域</a></div></div><div class="post rightside"><h1 class="artititle">升级老项目的包依赖</h1><div class="info"><i class="iconfont iconwenzi" title="字数">833</i><i class="iconfont iconshijian" title="阅读时长">3</i><i class="iconfont iconarchives" title="文章分类"><span>Frontend</span></i><i class="iconfont iconbiaoqian" title="文章标签"><span>npm</span></i><i class="iconfont iconshijian"><span title="文章发布时间">2025-05-25</span></i><i class="iconfont iconshijian"><span title="文章更新时间">2025-07-03</span></i></div><div class="postDetail"><h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><blockquote>
<p>项目使用 node v12， npm 管理，年代比较久远，现在要升级某一个工具包，但这个包并不是直接引用的，而是子包的依赖，但是这个项目要先于子包更新，所以需要单独更新这个工具包</p>
</blockquote>
<p>npm 的 oversides 可以很容易实现这个需求，但是这个功能是 node v16 才有的，所以需要先升级到 v16 才能使用这个功能</p>
<p>node 版本升级就碰到亿点点了 node-gyp 的问题，而后放弃 npm，转化为使用 yarn 的 resolutions，然后也碰到了 node 版本兼容问题</p>
<h2 id="Node-gyp-问题"><a href="#Node-gyp-问题" class="headerlink" title="Node-gyp 问题"></a>Node-gyp 问题</h2><ul>
<li>node-gyp 是用于编译 C/C++ 插件的工具。一些 node 包使用 C 来使用系统级别的 api 或者提升性能，所以这些包需要编译为二进制才能在 node 代码中引用，如果包作者没有提供和平台相应的二进制包，那 node-gyp 就会来做这件事</li>
<li>当切换 node 版本之后，一些插件需要重新编译，重新编译就需要提供环境, python 和 c ++ 工具链</li>
</ul>
<h3 id="node-gyp-版本问题"><a href="#node-gyp-版本问题" class="headerlink" title="node-gyp 版本问题"></a>node-gyp 版本问题</h3><ul>
<li>npm 内部会打包一份 node-gpy 的复制版本，所以全局装 node-gyp, npm 也不会用到，但是有一些小手段可以更新 npm 内部的版本</li>
<li><a target="_blank" rel="noopener" href="https://github.com/nodejs/node-gyp/blob/main/docs/Updating-npm-bundled-node-gyp.md">Updating-npm-bundled-node-gyp</a></li>
</ul>
<h3 id="找不到-python2-或-python3"><a href="#找不到-python2-或-python3" class="headerlink" title="找不到 python2 或 python3"></a>找不到 python2 或 python3</h3><ul>
<li>node-gyp 是对 google gyp 工具的封装，而 gyp((Generate Your Projects)) 是 python 写的，所以 python 是重新编译的必要条件</li>
<li>python v3 是不兼容 v2 的，如果 gyp 说它找不到 v2，那就最好给它 v2</li>
</ul>
<h2 id="node-版本兼容"><a href="#node-版本兼容" class="headerlink" title="node 版本兼容"></a>node 版本兼容</h2><ul>
<li><p>切换了管理工具，原来的 package.lock 对 yarn 实际上没有什么用，yarn 会生成 yarn.lock。大部分包的依赖的版本用<code>^</code>/<code>～</code> 来设置版本范围，本来项目初始化安装的时候这个包设的是^3.2, 可能当时最高版本就是3.2, 但是现在能找到最后一个版本 3.9. 比如 <a href="mailto:&#x6c;&#x65;&#x73;&#115;&#x40;&#x34;&#x2e;&#50;">&#x6c;&#x65;&#x73;&#115;&#x40;&#x34;&#x2e;&#50;</a> 是要求 nodev12，@<a href="mailto:&#108;&#x65;&#115;&#115;&#64;&#x34;&#46;&#51;">&#108;&#x65;&#115;&#115;&#64;&#x34;&#46;&#51;</a> 要求 nodev14 以上</p>
<ul>
<li>版本号格式：<ul>
<li><code>4.17.21</code>, 具体版本号</li>
<li><code>&gt;=4.0.0 &lt;5.0.0</code>, 字面意思，设定版本号范围</li>
<li><code>^4.17.21</code>    等于 <code>4.x.x</code>, 取最新以 4 开头的版本</li>
<li><code>~4.17.21</code>, 等于 <code>4.17.x</code>, 取最接近于这个设置的版本</li>
<li><code>4.*</code>, 等于 <code>4.x.x</code>，取最新以 4 开头的版本</li>
<li><code>*</code>, 取最新的版本</li>
</ul>
</li>
<li>包管理器决定依赖版本的逻辑的差异</li>
</ul>
</li>
<li><p><code>*</code> 这个版本设置，比如某些包对 <code>commander``webpack-dev-server</code> 依赖版本号设置是 <code>*</code>，这个符号本意是不在意包的版本，yarn 会去获取最新的包, 但是这就会导致 node 版本兼容问题</p>
</li>
<li><p>solve:</p>
<ul>
<li>刚开始可以尝试通过 <code>yarn import</code>(废弃但可用) 或者 <code>synp</code> 转换 package.json to yarn.lock.json</li>
<li>可以通过在 solutions 中指定版本来解决</li>
<li>最后的最后，还可以通过 <code>yarn install --ignore-engine</code> 来忽略这个问题，如果因为项目部署原因不方便修改依赖安装脚本的，也可以将 <code>--ignore-engine</code> 写在 <code>.yarnrc</code> 文件中可以省略掉后续维护流水线的麻烦<ul>
<li>不要尝试将 <code>install</code> 写在 <code>scripts</code> 企图替换，会造成命令循环</li>
</ul>
</li>
</ul>
</li>
</ul>
</div><link rel="stylesheet" href="/css/partial/footer.css"><div class="footer"><p><span>Copyright © 2017 - 2023</span><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">蜀ICP备19024124号</a></p><p><i class="iconfont iconchakan"><span>本站总访问量</span><span id="busuanzi_container_site_pv">  <span id="busuanzi_value_site_pv"></span> </span></i><i class="iconfont iconabout"><span>本站访客数</span><span id="busuanzi_container_site_uv">  <span id="busuanzi_value_site_uv"></span> </span></i></p></div></div><script> <console class="log" page theme></console></script></div></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>