<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="keywords" content="没事儿,tong-h,Tong-H,tong-h blog"><meta name="descriptioon" content="personal blog by Tong-H"><meta name="renderer" content="wekit"><link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/css/public.css"><link rel="stylesheet" href="/css/reset.css"><link rel="stylesheet" href="/css/iconfont.css"><title>canvas绘制dom计算分页自定义打印 [ Tong-H ]</title><link rel="stylesheet" href="/css/partial/footer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><link rel="stylesheet" href="/css/partial/sidebar.css"><link rel="stylesheet" href="/css/post.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><meta name="generator" content="Hexo 5.4.0"></head><body><link rel="stylesheet" href="/css/partial/header.css"><div class="header"><div class="maxwidth"><div class="nav"><a id="artlist" href="/404"><i class="iconfont icon404"></i><span class="headhid">&nbsp;404</span></a><a id="artlist" href="/archives"><i class="iconfont iconarchives"></i><span class="headhid">&nbsp;Archives</span></a><a id="artlist" href="/about"><i class="iconfont iconabout"></i><span class="headhid">&nbsp;About</span></a></div><a class="search" href="/">TONG-H</a></div></div><div class="main"> <div class="maxwidth"><link rel="stylesheet" href="/css/partial/sidebar.css"><div id="sidebar"><div class="social"><a href="/archives" title="Home"><i class="iconfont iconHome"></i></a><a href="mailto:tongt0232@gmail.com" title="E-Mail"><i class="iconfont iconweibiaoti554"></i></a><a target="_blank" rel="noopener" href="https://github.com/tong-h" title="GitHub"><i class="iconfont iconGitHub"></i></a><a target="_blank" rel="noopener" href="https://juejin.cn/user/1204720474809741" title="juejin"><img src="/images/juejinicon-sidebar.png"></a><a target="_blank" rel="noopener" href="https://www.jianshu.com/u/20de04cc53de" title="jianshu"><img src="/images/jianicon-sidebar.png"></a></div><div class="structure category-list"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E6%89%93%E5%8D%B0%E9%A1%B5%E9%9D%A2%E5%8A%A0%E7%B2%97%E7%9A%84%E5%AD%97%E4%BD%93%E7%9A%84%E6%98%BE%E7%A4%BA"><span class="toc-number">1.</span> <span class="toc-text">在打印页面加粗的字体的显示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9B%B4%E6%8D%A2%E5%AD%97%E4%BD%93"><span class="toc-number">1.1.</span> <span class="toc-text">1. 更换字体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-canvas-%E7%BB%98%E5%88%B6-dom"><span class="toc-number">1.2.</span> <span class="toc-text">2. canvas 绘制 dom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA%E5%AD%97%E4%BD%93%E9%87%8D%E5%8F%A0%E8%BE%BE%E5%88%B0%E5%8A%A0%E7%B2%97%E6%95%88%E6%9E%9C"><span class="toc-number">1.3.</span> <span class="toc-text">3. 使用多个字体重叠达到加粗效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B5%E5%A4%B4%E9%A1%B5%E8%84%9A%E8%87%AA%E5%AE%9A%E4%B9%89"><span class="toc-number">2.</span> <span class="toc-text">页头页脚自定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9C%A8-page-%E9%87%8C%E8%AE%BE%E7%BD%AE-margin"><span class="toc-number">2.1.</span> <span class="toc-text">1. 在 @page 里设置 margin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BF%AE%E6%94%B9-url"><span class="toc-number">2.2.</span> <span class="toc-text">2. 修改 url</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%B0%9D%E8%AF%95%E4%BD%BF%E7%94%A8-counter-increment%E3%80%81counter-%E5%8A%A0%E4%B8%8A%E9%A1%B5%E7%A0%81"><span class="toc-number">2.3.</span> <span class="toc-text">3. 尝试使用 counter-increment、counter() 加上页码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%9C%80%E7%BB%88%E6%96%B9%E6%A1%88%EF%BC%9A%E4%BD%BF%E7%94%A8-canvas-%E7%BB%98%E5%88%B6-dom-%E8%AE%A1%E7%AE%97%E5%88%86%E9%A1%B5%E6%9C%80%E5%90%8E%E7%94%9F%E6%88%90%E5%9B%BE%E7%89%87%E6%89%93%E5%8D%B0%EF%BC%8C%E8%A7%A3%E5%86%B3%E6%89%80%E6%9C%89%E5%8E%9F%E7%94%9F%E9%97%AE%E9%A2%98"><span class="toc-number">2.4.</span> <span class="toc-text">4. 最终方案：使用 canvas 绘制 dom 计算分页最后生成图片打印，解决所有原生问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">3.</span> <span class="toc-text">其他</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%96%87%E7%AB%A0"><span class="toc-number">4.</span> <span class="toc-text">相关文章</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">5.</span> <span class="toc-text">参考文章</span></a></li></ol></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Daily-Snippets/">Daily Snippets</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Frontend/">Frontend</a><span class="category-list-count">48</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Notes/">Notes</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Others/">Others</a><span class="category-list-count">14</span></li></ul><div class="tags"><a href="/tags/CI-CD/" style="font-size: 12px; color: #ffac00">CI/CD</a> <a href="/tags/Cache/" style="font-size: 15px; color: #ec9d00">Cache</a> <a href="/tags/ECharts/" style="font-size: 12px; color: #ffac00">ECharts</a> <a href="/tags/Electron/" style="font-size: 12px; color: #ffac00">Electron</a> <a href="/tags/Git/" style="font-size: 12px; color: #ffac00">Git</a> <a href="/tags/JS/" style="font-size: 12px; color: #ffac00">JS</a> <a href="/tags/JSON/" style="font-size: 12px; color: #ffac00">JSON</a> <a href="/tags/Linux/" style="font-size: 12px; color: #ffac00">Linux</a> <a href="/tags/OTHERS/" style="font-size: 12px; color: #ffac00">OTHERS</a> <a href="/tags/Svg/" style="font-size: 12px; color: #ffac00">Svg</a> <a href="/tags/angular/" style="font-size: 15px; color: #ec9d00">angular</a> <a href="/tags/canvas/" style="font-size: 21px; color: #c77e00">canvas</a> <a href="/tags/cordova/" style="font-size: 21px; color: #c77e00">cordova</a> <a href="/tags/domain/" style="font-size: 12px; color: #ffac00">domain</a> <a href="/tags/ffmpeg/" style="font-size: 12px; color: #ffac00">ffmpeg</a> <a href="/tags/financial/" style="font-size: 12px; color: #ffac00">financial</a> <a href="/tags/gitment/" style="font-size: 12px; color: #ffac00">gitment</a> <a href="/tags/hexo/" style="font-size: 18px; color: #da8d00">hexo</a> <a href="/tags/http/" style="font-size: 12px; color: #ffac00">http</a> <a href="/tags/japanese/" style="font-size: 15px; color: #ec9d00">japanese</a> <a href="/tags/js/" style="font-size: 12px; color: #ffac00">js</a> <a href="/tags/markdown/" style="font-size: 12px; color: #ffac00">markdown</a> <a href="/tags/micro-frontend/" style="font-size: 15px; color: #ec9d00">micro_frontend</a> <a href="/tags/mpvue/" style="font-size: 12px; color: #ffac00">mpvue</a> <a href="/tags/mysql/" style="font-size: 12px; color: #ffac00">mysql</a> <a href="/tags/nginx/" style="font-size: 12px; color: #ffac00">nginx</a> <a href="/tags/nodejs/" style="font-size: 12px; color: #ffac00">nodejs</a> <a href="/tags/npm/" style="font-size: 12px; color: #ffac00">npm</a> <a href="/tags/python/" style="font-size: 18px; color: #da8d00">python</a> <a href="/tags/server/" style="font-size: 12px; color: #ffac00">server</a> <a href="/tags/shell/" style="font-size: 12px; color: #ffac00">shell</a> <a href="/tags/threeJs/" style="font-size: 12px; color: #ffac00">threeJs</a> <a href="/tags/translation/" style="font-size: 24px; color: #b46e00">translation</a> <a href="/tags/typescript/" style="font-size: 12px; color: #ffac00">typescript</a> <a href="/tags/vue/" style="font-size: 12px; color: #ffac00">vue</a> <a href="/tags/worker/" style="font-size: 12px; color: #ffac00">worker</a> <a href="/tags/yarn/" style="font-size: 12px; color: #ffac00">yarn</a> <a href="/tags/%E5%8E%9F%E5%9E%8B%E9%93%BE/" style="font-size: 12px; color: #ffac00">原型链</a> <a href="/tags/%E5%9B%BD%E9%99%85%E5%8C%96/" style="font-size: 12px; color: #ffac00">国际化</a> <a href="/tags/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%BB%9A%E5%8A%A8%E6%9D%A1/" style="font-size: 12px; color: #ffac00">自定义滚动条</a> <a href="/tags/%E8%B7%A8%E5%9F%9F/" style="font-size: 12px; color: #ffac00">跨域</a></div></div><div class="post rightside"><h1 class="artititle">canvas绘制dom计算分页自定义打印</h1><div class="info"><i class="iconfont iconwenzi" title="字数">2.1k</i><i class="iconfont iconshijian" title="阅读时长">9</i><i class="iconfont iconarchives" title="文章分类"><span>Frontend</span></i><i class="iconfont iconbiaoqian" title="文章标签"><span>canvas</span></i><i class="iconfont iconshijian"><span title="文章发布时间">2021-03-15</span></i><i class="iconfont iconshijian"><span title="文章更新时间">2025-02-23</span></i></div><div class="postDetail"><p>原生打印香吗？当然香啊，window.print() 页头页尾页码统统有，还能用 @media print 设置打印样式，没什么问题，棒棒的舒舒服服的；但是（没有但是也没这篇文章了🙃🙃🙃）分享分享一些我踩到的坑，以及我的解决方案</p>
<h2 id="在打印页面加粗的字体的显示"><a href="#在打印页面加粗的字体的显示" class="headerlink" title="在打印页面加粗的字体的显示"></a>在打印页面加粗的字体的显示</h2><p>现在字体大部分都用苹方，微软雅黑之类的，好看又百搭，但是偶尔也会有UI要求或者其他原因引起的特殊需求需要其他字体，就会惊喜的发现明明设置了 css，页面显示出来的也是font-weight: bold 的效果，但是在打印下却还是和 font-weight: normal 一样。</p>
<p>我用的是宋体，如果你和我一样 <strong>1.字体是动态 2.需要加粗 3.这个字体没有加粗的版本 4.还需要打印</strong><br>可以试试我的替代方案:</p>
<h3 id="1-更换字体"><a href="#1-更换字体" class="headerlink" title="1. 更换字体"></a>1. 更换字体</h3><p>在 @media print 为需要加粗的文字更换其他字体，缺点就是因为不是配套的字体可能会不协调，而且文字如果是动态的，那么加载一个字体包可能会影响用户体验</p>
<h3 id="2-canvas-绘制-dom"><a href="#2-canvas-绘制-dom" class="headerlink" title="2. canvas 绘制 dom"></a>2. canvas 绘制 dom</h3><p>虽然我后来也用了这个但是是因为另外的问题，所以如果仅仅因为字体加粗的话…嗯 …. 🤐🤐，看第三个👇👇👇</p>
<h3 id="3-使用多个字体重叠达到加粗效果"><a href="#3-使用多个字体重叠达到加粗效果" class="headerlink" title="3. 使用多个字体重叠达到加粗效果"></a>3. 使用多个字体重叠达到加粗效果</h3><p>这是我当时用的办法，用 before + after + attr() 重叠达到加粗效果</p>
<pre><code>    <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.strong</span> &#123;</span><br><span class="line">	<span class="attribute">font-weight</span>: normal;</span><br><span class="line">	<span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.strong</span><span class="selector-pseudo">::before</span> &#123;</span><br><span class="line">	<span class="attribute">content</span>: <span class="built_in">attr</span>(data-text);</span><br><span class="line">	<span class="attribute">z-index</span>: -<span class="number">1</span>;</span><br><span class="line">	<span class="attribute">line-height</span>: <span class="number">100%</span>;</span><br><span class="line">	<span class="attribute">position</span>: absolute;</span><br><span class="line">	<span class="attribute">display</span>: inline-block;</span><br><span class="line">	<span class="attribute">left</span>: -<span class="number">0.8px</span>;</span><br><span class="line">	<span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">	<span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.strong</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">	<span class="attribute">content</span>: <span class="built_in">attr</span>(data-text);</span><br><span class="line">	<span class="attribute">z-index</span>: -<span class="number">1</span>;</span><br><span class="line">	<span class="attribute">line-height</span>: <span class="number">100%</span>;</span><br><span class="line">	<span class="attribute">position</span>: absolute;</span><br><span class="line">	<span class="attribute">display</span>: inline-block;</span><br><span class="line">	<span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">	<span class="attribute">top</span>: -<span class="number">0.4px</span>;</span><br><span class="line">	<span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
<h2 id="页头页脚自定义"><a href="#页头页脚自定义" class="headerlink" title="页头页脚自定义"></a>页头页脚自定义</h2><p>原生打印含有页头页脚，可以自定义 margin, size，但无法自定义页头页脚内容，页头页脚含有日期，url，页码，网站 title，但我…只需要页码<br><a target="_blank" rel="noopener" href="https://developers.google.com/web/tools/chrome-devtools/css/print-preview">在 f12 查看打印样式</a>：ctrl + shift + p 展开命令菜单输入 show rendering，在 emulate css media type 选择 print</p>
<h3 id="1-在-page-里设置-margin"><a href="#1-在-page-里设置-margin" class="headerlink" title="1. 在 @page 里设置 margin"></a>1. 在 @page 里设置 margin</h3><p>不要页头 margin-top：0；不要页脚 margin-bottom：0, 如果不要页脚 url 是没了同样的页码也没了；什么都不需要 margin: 0，也可以在打印高级设置里隐藏页头页脚；</p>
<p>不管是margin-top：0，margin: 0，页头页脚是没了且页面的边距也没了，可以用元素 padding 或 margin 撑开但是如果是多页在分页的地方有可能会出现没有边距的情况</p>
<h3 id="2-修改-url"><a href="#2-修改-url" class="headerlink" title="2. 修改 url"></a>2. 修改 url</h3><p>使用 history API 修改 url, <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/History/pushState">MDN History.pushState()</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">history.pushState(&#123;&#125;, <span class="string">&quot;&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="built_in">window</span>.print()</span><br><span class="line">history.back()</span><br></pre></td></tr></table></figure>

<p>最后只剩下网站域名，但对我来说好像不是很行</p>
<h3 id="3-尝试使用-counter-increment、counter-加上页码"><a href="#3-尝试使用-counter-increment、counter-加上页码" class="headerlink" title="3. 尝试使用 counter-increment、counter() 加上页码"></a>3. 尝试使用 counter-increment、counter() 加上页码</h3><p>全部隐藏后尝试使用 counter-increment 和 CSS计数器 counter() 加上页码, <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/counter-increment">MDN counter-increment</a> <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/counter-increment">MDN CSS counter</a></p>
<p>body 里重置 page，固定 #pageNum 在页面重复渲染，counter-increment 增加 page 值，couter() 显示 page</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">	<span class="attribute">counter-reset</span>: page</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#pageNum</span> &#123;</span><br><span class="line">	<span class="attribute">position</span>: fixed;</span><br><span class="line">	<span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">	<span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@media</span> print &#123;</span><br><span class="line">	<span class="keyword">@page</span> &#123;</span><br><span class="line">		size: auto;</span><br><span class="line">		<span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="selector-id">#pageNum</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">		<span class="attribute">counter-increment</span>: page;</span><br><span class="line">		<span class="attribute">content</span>: <span class="string">&quot;Page &quot;</span><span class="built_in">counter</span>(page);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Google 不生效始终显示 0，Firefox 只在第一页显示总页面数….. 😶😶😶😶</p>
<h3 id="4-最终方案：使用-canvas-绘制-dom-计算分页最后生成图片打印，解决所有原生问题"><a href="#4-最终方案：使用-canvas-绘制-dom-计算分页最后生成图片打印，解决所有原生问题" class="headerlink" title="4. 最终方案：使用 canvas 绘制 dom 计算分页最后生成图片打印，解决所有原生问题"></a>4. 最终方案：使用 canvas 绘制 dom 计算分页最后生成图片打印，解决所有原生问题</h3><p>如果你不太了解 canvas，底部👇👇👇可以查看以往相关文章</p>
<p>1.dom 变 svg, 再变 image src</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> scale = <span class="number">3</span></span><br><span class="line"><span class="keyword">var</span> el = <span class="built_in">document</span>.querySelector(<span class="string">&quot;content&quot;</span>), svg, img = <span class="keyword">new</span> Image(),</span><br><span class="line">	cav = <span class="built_in">document</span>.createElement(<span class="string">&quot;canvas&quot;</span>), ctx, imagedata,</span><br><span class="line">	pages = <span class="number">0</span>, margintop = <span class="number">100</span> * scale, marginleft = <span class="number">0</span> * scale, height = <span class="number">1122</span> * scale, pageheight;</span><br><span class="line">pageheight = height - margintop * <span class="number">2</span></span><br><span class="line">ctx = cav.getContext(<span class="string">&quot;2d&quot;</span>)</span><br><span class="line">img.setAttribute(<span class="string">&#x27;crossOrigin&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">img.className = <span class="string">&quot;printpage&quot;</span></span><br><span class="line">svg = <span class="string">`data:image/svg+xml;charset=utf-8,&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;<span class="subst">$&#123;el.clientWidth&#125;</span>&quot; height=&quot;<span class="subst">$&#123;el.clientHeight&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">		&lt;foreignObject x=&quot;0&quot; y=&quot;0&quot; width=&quot;100%&quot; height=&quot;100%&quot;&gt;</span></span><br><span class="line"><span class="string">			&lt;style&gt;<span class="subst">$&#123;style&#125;</span>&lt;/style&gt;</span></span><br><span class="line"><span class="string">			<span class="subst">$&#123;<span class="keyword">new</span> XMLSerializer().serializeToString(el)&#125;</span></span></span><br><span class="line"><span class="string">		&lt;/foreignObject&gt;</span></span><br><span class="line"><span class="string">	&lt;/svg&gt;`</span>;</span><br><span class="line">img.src = svg.replace(<span class="regexp">/\n/g</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="regexp">/\t/g</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="regexp">/#/g</span>, <span class="string">&#x27;%23&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li> canvas 是根据像素绘制，所以 canvas 绘制的时候使用同样的和 dom 一样的尺寸正常在电脑看没问题但是打印就会变得模糊，而 svg 是矢量图，所以应该放大 image 再绘制 canvas，但是同样的如果绘制尺寸太大会非常影响性能所以根据情况调整，我是设置放大三倍左右;</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cav.height = img.height * scale</span><br><span class="line">cav.width = img.width * scale</span><br><span class="line">ctx.fillStyle = <span class="string">&#x27;#fff&#x27;</span></span><br><span class="line">ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, cav.width, cav.height)</span><br><span class="line">ctx.drawImage(img, <span class="number">0</span>, <span class="number">0</span>, img.width * scale, img.height * scale)</span><br><span class="line">img.src = cav.toDataURL()</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>按照打印页面高度计算总页数，这个总页数不一定是最后的总页数，扣除上边距后开始绘制图片，图片绘制完成后再绘制页脚，页脚的位置也应该是计算总长度后取中间位置</li>
<li>循环页数绘制图片，由于是图片所以分页的地方需要尤其注意，避免在文字中间被分开；循环 imagedata 扫描像素点，对比背景</li>
<li>如果一行文字因为分页从中间被截掉那么被截的上半部分应该要留到下一页再绘制，同时要记下这上部分的高度<br>ps: 因为我的页面是纯文字白色背景，所以如果你的页面有图片或者其他色块，那么可能需要注意如果是被截的是图片或者其他的和文字颜色相同的色块，通常可能是不需要去避免这个截断，那么或许可以在 dom 的时候做一些准备比如记下位置什么的</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pages = <span class="built_in">Math</span>.ceil(img.height / pageh)</span><br><span class="line">cav.height = pages * height</span><br><span class="line">cav.width = img.width</span><br><span class="line">ctx.fillStyle = <span class="string">&#x27;#fff&#x27;</span></span><br><span class="line">ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, cav.width, cav.height)</span><br><span class="line"><span class="keyword">var</span> point = <span class="number">0</span>, tw = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> p = <span class="number">0</span>; p &lt; pages; p++) &#123;</span><br><span class="line">	ctx.drawImage(</span><br><span class="line">		img,</span><br><span class="line">		<span class="number">0</span>, point, img.width, pageh,</span><br><span class="line">		marginl, margint + p * height, img.width, pageh</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">var</span> iscut = <span class="literal">true</span>, rows = <span class="number">0</span></span><br><span class="line">	<span class="keyword">while</span> (iscut &amp;&amp; rows &lt; <span class="number">120</span>) &#123;</span><br><span class="line">		imagedata = ctx.getImageData(marginl, (p + <span class="number">1</span>) * height - margint - (rows + <span class="number">1</span>), img.width, <span class="number">1</span>)</span><br><span class="line">		iscut = <span class="literal">false</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; imagedata.data.length; i += <span class="number">2</span> * <span class="number">4</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (imagedata.data[i] === <span class="number">0</span>) &#123;</span><br><span class="line">				rows++</span><br><span class="line">				iscut = <span class="literal">true</span></span><br><span class="line">				rows === <span class="number">120</span> &amp;&amp; <span class="built_in">console</span>.log(<span class="string">&quot;陷入循环&quot;</span> + p)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	point += (pageh - rows)</span><br><span class="line">	ctx.fillRect(marginl, (p + <span class="number">1</span>) * height - margint - rows, img.width, rows)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>由于我们的高度已经算好了，那么现在由于被截掉的文字的原因，剩余的需要绘制的高度也发生了变化，所以在画完当前总页数的最后一页后如果还有图片还未绘制完成应该加一，再绘制一页，canvas 尺寸也要进行同步更新</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pages === p + <span class="number">1</span> &amp;&amp; point &lt; img.height) &#123;</span><br><span class="line">	pages += <span class="number">1</span></span><br><span class="line">	<span class="keyword">var</span> oldcav = ctx.getImageData(<span class="number">0</span>, <span class="number">0</span>, cav.width, cav.height)</span><br><span class="line">	cav.height = pages * height</span><br><span class="line">	ctx.fillStyle = <span class="string">&#x27;#fff&#x27;</span></span><br><span class="line">	ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, cav.width, cav.height)</span><br><span class="line">	ctx.putImageData(oldcav, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>ok，现在图片绘制完成，页数也算完了，就可以绘制页码了</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ctx.fillStyle = <span class="string">&#x27;#000&#x27;</span></span><br><span class="line">ctx.font = <span class="string">&quot;normal normal &quot;</span> + scale * <span class="number">14</span> + <span class="string">&quot;px SimSun, Avenir, Helvetica Neue, Helvetica, Arial, sans-serif&quot;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> p = <span class="number">0</span>; p &lt; pages; p++) &#123;</span><br><span class="line">	tw = ctx.measureText(<span class="string">&quot;第&quot;</span> + (p + <span class="number">1</span>) + <span class="string">&quot;页 共&quot;</span> + pages + <span class="string">&quot;页&quot;</span>)</span><br><span class="line">	ctx.fillText(<span class="string">&quot;第&quot;</span> + (p + <span class="number">1</span>) + <span class="string">&quot;页 共&quot;</span> + pages + <span class="string">&quot;页&quot;</span>, (cav.width - tw.width) / <span class="number">2</span>, (p + <span class="number">1</span>) * height - (margint / <span class="number">2</span>))</span><br><span class="line">&#125;</span><br><span class="line">img.src = cav.toDataURL()</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>页码绘制完成后将 image 调成原始尺寸进行打印，放入body进行打印</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">img.width = img.width / scale</span><br><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">&quot;.printpage&quot;</span>) &amp;&amp; <span class="built_in">document</span>.querySelector(<span class="string">&quot;.printpage&quot;</span>).remove()</span><br><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">&quot;body&quot;</span>).insertBefore(img, el)</span><br><span class="line"><span class="built_in">window</span>.print()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="10">
<li>css 样式部分可以做一些简单隐藏显示处理，在打印时隐藏正常页面内容，显示绘制完成的image</li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.content</span> &#123;</span><br><span class="line">	<span class="attribute">display</span>: block;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.printpage</span> &#123;</span><br><span class="line">	<span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@media</span> print &#123;</span><br><span class="line">	<span class="keyword">@page</span> &#123;</span><br><span class="line">		size: auto;</span><br><span class="line">		<span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="selector-class">.printpage</span> &#123;</span><br><span class="line">		<span class="attribute">display</span>: block;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="selector-class">.content</span> &#123;</span><br><span class="line">		<span class="attribute">display</span>: none;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>实际上我之前还有一个问题是 input 或 textarea 在打印下不显示输入的内容，因为，后来手动赋值解决，但是在写博客我发现我没办法复现那个问题了，尝试了 js 赋值、插入 dom、手动输入各种操作并没有出现我预期的 bug，everything is fine….，所以🤐🤐🤐</p>
<h2 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h2><p><a href="https://mser.xyz/tags/canvas/">canvas 相关</a><br><a href="https://mser.xyz/2019/02/21/canvas-1/">canvas 的 imagedata 对象</a></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Lists_and_Counters/Using_CSS_counters#displaying_a_counter">MDN: Displaying a counter</a></p>
<p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/how-to-remove-url-from-printing-the-page/">How to hide an element when printing a web page using CSS?</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/58227220/how-to-change-the-url-from-the-printing-page">stackoverflow: How to change the URL from the printing page?</a></p>
</div><div class="copyright"><p>更新时间：2021-03-15</p>转载请注明来源，欢迎指出任何有错误或不够清晰的表达</div><link rel="stylesheet" href="/css/partial/footer.css"><div class="footer"><p><span>Copyright © 2017 - 2023</span><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/">蜀ICP备19024124号</a></p><p><i class="iconfont iconchakan"><span>本站总访问量</span><span id="busuanzi_container_site_pv">  <span id="busuanzi_value_site_pv"></span> </span></i><i class="iconfont iconabout"><span>本站访客数</span><span id="busuanzi_container_site_uv">  <span id="busuanzi_value_site_uv"></span> </span></i></p></div></div><script> <console class="log" page theme></console></script></div></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>